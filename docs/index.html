<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VaultFlow</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");
    :root {
      color-scheme: light;
      --bg: #0f172a;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0b1224;
      --border: #e5e7eb;
      --primary: #0f172a;
      --accent: #0ea5e9;
      --success: #0ea76b;
      --danger: #ef4444;
      --shadow: 0 16px 60px rgba(15, 23, 42, 0.12);
      --soft: #f8fafc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px at 15% 20%, #e8f4ff, transparent),
        radial-gradient(900px at 80% 0%, #e2f5ed, transparent),
        #f8fafc;
      color: var(--text);
      min-height: 100vh;
    }
    h1,h2,h3 { margin: 0; }
    p { margin: 0; }
    .muted { color: var(--muted); }
    .err { color: var(--danger); white-space: pre-wrap; margin-top: 6px; }
    .ok { color: var(--success); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .app-shell {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
      transition: grid-template-columns 0.25s ease;
    }
    .app-shell.collapsed { grid-template-columns: 92px 1fr; }
    .sidebar {
      background: linear-gradient(180deg, #0f172a 0%, #0b1224 100%);
      color: #e2e8f0;
      padding: 22px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      width: 100%;
      overflow: hidden;
    }
    .brand-row {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, #0ea5e9, #22d3ee);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b1224;
      letter-spacing: -0.5px;
      flex-shrink: 0;
    }
    .brand-text { display: grid; gap: 2px; }
    .brand-name { font-weight: 700; letter-spacing: -0.2px; }
    .brand-sub { font-size: 12px; color: #94a3b8; }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.06);
      color: #e2e8f0;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .icon-btn:hover { transform: translateY(-1px); background: rgba(255, 255, 255, 0.1); }
    .nav { display: grid; gap: 6px; }
    .nav-item {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: #e2e8f0;
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      white-space: nowrap;
      overflow: hidden;
    }
    .nav-item:hover { background: rgba(255, 255, 255, 0.05); }
    .nav-item.active { border-color: rgba(255, 255, 255, 0.16); background: rgba(255, 255, 255, 0.08); }
    .sidebar-footer {
      margin-top: auto;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      display: grid;
      gap: 8px;
    }
    .sidebar-footer .label { font-size: 12px; color: #94a3b8; }
    .sidebar-footer .strong { font-weight: 600; }
    .main-area { background: transparent; }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 28px 32px 10px;
    }
    .eyebrow { text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 6px; }
    .top-actions { display: flex; align-items: center; gap: 10px; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
    }
    .content { padding: 0 32px 32px; display: grid; gap: 16px; }
    .card, .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .card { padding: 20px; }
    .panel { padding: 18px 18px 16px; }
    .panel-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 14px; }
    .panel-footer { margin-top: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .auth-card { display: grid; gap: 12px; border: 1px solid #dbeafe; background: linear-gradient(135deg, #ffffff, #f8fbff); }
    .auth-grid { display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select, textarea {
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      min-width: 200px;
      font: inherit;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.12); }
    button {
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid var(--primary);
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      letter-spacing: -0.2px;
    }
    button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: #fff; color: var(--primary); border-color: var(--border); }
    button.ghost { background: #f8fafc; color: var(--text); border-color: var(--border); }
    .app-grid { display: grid; gap: 16px; }
    .page { display: none; }
    .page.active { display: grid; gap: 14px; }
    .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; align-items: end; }
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 10px 0 6px; }
    .metric-card { padding: 14px; border-radius: 14px; border: 1px solid var(--border); background: linear-gradient(150deg, #ffffff, #f8fafc); display: grid; gap: 6px; }
    .metric-card .label { font-size: 13px; color: var(--muted); }
    .metric-card .value { font-size: 24px; font-weight: 700; letter-spacing: -0.3px; }
    .metric-card.income { border-color: rgba(14, 167, 107, 0.2); background: linear-gradient(135deg, #f0fdf4, #f8fffb); }
    .metric-card.expense { border-color: rgba(239, 68, 68, 0.2); background: linear-gradient(135deg, #fff1f2, #fff7f7); }
    .metric-card.balance { background: linear-gradient(135deg, #e0f2fe, #f8fbff); border-color: rgba(14, 165, 233, 0.2); }
    .mini-label { font-size: 12px; color: var(--muted); }
    .kpi { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #f8fafc; }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 18px; font-weight: 700; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 10px; background: var(--soft); border: 1px solid var(--border); font-size: 12px; color: var(--text); }
    .tabs { display: inline-flex; gap: 8px; background: #f8fafc; padding: 6px; border-radius: 12px; border: 1px solid var(--border); margin: 8px 0 4px; }
    .tab { padding: 8px 12px; border-radius: 10px; border: 1px solid transparent; background: transparent; cursor: pointer; font-size: 13px; color: var(--text); font-weight: 600; }
    .tab.active { background: #fff; border-color: var(--border); box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08); }
    .info-note { background: #f8fafc; border: 1px dashed var(--border); border-radius: 12px; padding: 10px 12px; color: var(--muted); margin: 6px 0 2px; }
    .table-shell { border: 1px solid var(--border); border-radius: 14px; overflow: hidden; background: #fff; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { font-size: 12px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--muted); }
    td { font-size: 14px; }
    td .muted { font-size: 12px; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    .table-shell.large { max-height: 420px; overflow: auto; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; align-items: end; }
    .chip-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .divider { height: 1px; background: var(--border); margin: 14px 0; }
    .list-panel { padding-bottom: 10px; grid-column: 1 / -1; }
    .stack-list { display: grid; gap: 10px; }
    .move-card { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #fff; display: grid; gap: 4px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05); }
    .move-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); }
    .move-amount { font-weight: 700; }
    .actions { display: flex; gap: 6px; justify-content: flex-end; }
    .icon-action { border: 1px solid var(--border); background: var(--soft); border-radius: 10px; padding: 8px 10px; cursor: pointer; }
    .icon-action:hover { background: #fff; }
    @media (max-width: 1180px) {
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { position: relative; height: auto; border-right: none; }
      .app-grid { grid-template-columns: 1fr; }
      .page.active { grid-template-columns: 1fr; }
    }
    @media (max-width: 720px) {
      .topbar, .panel-header { flex-direction: column; align-items: flex-start; }
      .content { padding: 0 18px 24px; }
      .card, .panel { padding: 16px; }
    }
    .app-shell.collapsed .brand-text,
    .app-shell.collapsed .nav-item span,
    .app-shell.collapsed .sidebar-footer .label,
    .app-shell.collapsed .sidebar-footer .strong,
    .app-shell.collapsed .sidebar-footer .mono { display: none; }
    .app-shell.collapsed .nav-item { justify-content: center; text-align: center; padding: 12px 10px; min-height: 44px; }
    .app-shell.collapsed .nav-item::after { content: attr(data-short); color: #e2e8f0; font-weight: 700; letter-spacing: -0.2px; }
  </style>
</head>
<body>
<div class="app-shell">
  <aside class="sidebar">
    <div class="brand-row">
      <div class="brand">
        <div class="logo">VF</div>
        <div class="brand-text">
          <div class="brand-name">VaultFlow</div>
          <div class="brand-sub">Fintech control</div>
        </div>
      </div>
      <button class="icon-btn" id="sidebarToggle" aria-label="Recolher menu" type="button">?</button>
    </div>

    <nav class="nav">
      <button class="nav-item active" type="button" data-short="D" data-page-target="dashboard"><span>Dashboard</span></button>
      <button class="nav-item" type="button" data-short="T" data-page-target="transactions"><span>Transa√ß√µes</span></button>
      <button class="nav-item" type="button" data-short="C" data-page-target="categories"><span>Categorias</span></button>
      <button class="nav-item" type="button" data-short="S" data-page-target="settings"><span>Config</span></button>
    </nav>

    <div class="sidebar-footer">
      <div class="label">Sess?o</div>
      <div class="strong" id="me">Aguardando login</div>
      <button id="btnLogout" class="ghost" style="display:none;">Sair</button>
    </div>
  </aside>

  <div class="main-area">
    <header class="topbar">
      <div>
        <p class="eyebrow">VaultFlow</p>
        <h1 id="pageTitle">Dashboard</h1>
      </div>
      <div class="top-actions">
        <span class="chip">Controle financeiro</span>
      </div>
    </header>

    <main class="content">
      <section class="card auth-card" id="authCard">
        <div class="panel-header" style="margin-bottom:0;">
          <div>
            <p class="eyebrow">Acesso</p>
            <h2>Entrar</h2>
          </div>
          <p id="authStatus" class="muted"></p>
        </div>
        <div class="auth-grid">
          <div class="form-grid">
            <div>
              <label for="email">E-mail</label>
              <input id="email" type="email" placeholder="seu@email.com" autocomplete="username" />
            </div>
            <div>
              <label for="pass">Senha</label>
              <input id="pass" type="password" placeholder="********" autocomplete="current-password" />
            </div>
          </div>
          <div class="row">
            <button id="btnEmail">Entrar com e-mail</button>
            <button id="btnGoogle" class="secondary">Google</button>
          </div>
        </div>
        <p id="authError" class="err"></p>
      </section>

      <section class="app-grid" id="appGrid" style="display:none;">
        <section class="page active" id="page-dashboard">
          <div class="panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Carteira</p>
                <h2>Dashboard</h2>
              </div>
            </div>

            <div class="filters">
              <div>
                <label for="walletSelect">Carteira</label>
                <select id="walletSelect"></select>
              </div>
              <div>
                <label for="month">M?s</label>
                <input id="month" type="month" />
              </div>
              <div style="display:flex; gap:8px; align-items:flex-end;">
                <button id="btnReload" class="ghost">Atualizar</button>
              </div>
            </div>

            <p class="muted" id="walletInfo" style="margin-top:8px;"></p>
            <p class="err" id="appError"></p>

            <div class="kpi-row" id="kpis">
              <div class="metric-card income">
                <div class="label">Receitas</div>
                <div class="value" id="kpiIncome">R$ 0,00</div>
                <div class="mini-label">Entradas no per?odo</div>
              </div>
              <div class="metric-card expense">
                <div class="label">Despesas</div>
                <div class="value" id="kpiExpense">R$ 0,00</div>
                <div class="mini-label">Sa?das no per?odo</div>
              </div>
              <div class="metric-card balance">
                <div class="label">Saldo</div>
                <div class="value" id="kpiBalance">R$ 0,00</div>
                <div class="mini-label">Resultado consolidado</div>
              </div>
            </div>

            <div class="tabs" id="coupleTabs" style="display:none;">
              <button class="tab active" data-tab="totals">Totais</button>
              <button class="tab" data-tab="details">Detalhes</button>
            </div>

            <div id="coupleHint" class="info-note" style="display:none;">
              Vis?o consolidada: sincronizada automaticamente a partir das carteiras individuais.
            </div>

            <div id="coupleBreakdown" style="display:none; margin-top:10px;"></div>
          </div>

          <div class="panel list-panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Movimenta√ß√µes</p>
                <h2>Receitas e despesas</h2>
              </div>
            </div>
            <div class="form-grid">
              <div>
                <h3>Receitas</h3>
                <div id="incomeList" class="stack-list"></div>
              </div>
              <div>
                <h3>Despesas</h3>
                <div id="expenseList" class="stack-list"></div>
              </div>
            </div>
            <p class="muted" id="dashboardStatus"></p>
          </div>
        </section>

        <section class="page" id="page-transactions">
          <div class="panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Fluxo</p>
                <h3>Transa√ß√µes</h3>
              </div>
            </div>
            <div class="form-grid">
              <div>
                <label for="txnDate">Data</label>
                <input id="txnDate" type="date" />
              </div>
              <div>
                <label for="txnType">Tipo</label>
                <select id="txnType">
                  <option value="expense">Despesa</option>
                  <option value="income">Receita</option>
                </select>
              </div>
              <div>
                <label for="txnCat">Categoria</label>
                <select id="txnCat"></select>
              </div>
            </div>

            <div class="form-grid" style="margin-top:10px;">
              <div>
                <label for="txnAmount">Valor</label>
                <input id="txnAmount" placeholder="Ex.: 35,90" />
              </div>
              <div>
                <label for="txnNote">Descri√ß√£o (opcional)</label>
                <input id="txnNote" placeholder="Observa√ß√£o" />
              </div>
              <div style="display:flex; align-items:flex-end; justify-content:flex-start;">
                <button id="btnAddTxn">Adicionar</button>
              </div>
            </div>
            <p class="muted" id="txnStatus" style="margin-top:10px;"></p>
            <p class="err" id="opsError"></p>
          </div>

          <div class="panel list-panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Movimenta√ß√µes</p>
                <h2>Lista do m?s</h2>
              </div>
            </div>
            <div class="table-shell large">
              <table>
                <thead>
                  <tr>
                    <th class="nowrap">Data</th>
                    <th>Categoria</th>
                    <th>Descri√ß√£o</th>
                    <th class="right nowrap">Valor</th>
                    <th class="right nowrap">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="txnTable"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="page" id="page-categories">
          <div class="panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Organiza√ß√£o</p>
                <h3>Categorias</h3>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="catName">Nome</label>
                <input id="catName" placeholder="Ex.: Alimenta√ß√£o" />
              </div>
              <div>
                <label for="catKind">Tipo</label>
                <select id="catKind">
                  <option value="expense">Despesa</option>
                  <option value="income">Receita</option>
                  <option value="both">Ambos</option>
                </select>
              </div>
              <div class="row">
                <button id="btnAddCat">Adicionar</button>
                <button id="btnSeedCats" class="ghost">Categorias padr?o</button>
              </div>
            </div>
            <div class="muted" id="catStatus" style="margin-top:6px;"></div>
            <div class="table-shell" style="margin-top:10px; max-height: 240px; overflow:auto;">
              <table>
                <thead>
                  <tr><th>Nome</th><th>Tipo</th><th class="right">A√ß√µes</th></tr>
                </thead>
                <tbody id="catTable"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="page" id="page-settings">
          <div class="panel">
            <div class="panel-header">
              <div>
                <p class="eyebrow">Sess?o</p>
                <h3>Prefer?ncias</h3>
              </div>
            </div>
            <p class="muted">Use o menu para navegar. Seus dados sincronizam automaticamente.</p>
          </div>
        </section>
      </section>
    </main>
  </div>
</div>

<script type="module">


  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

  import {
    getFirestore,
    Timestamp,
    doc,
    getDoc,
    setDoc,
    deleteDoc,
    collection,
    getDocs,
    addDoc,
    query,
    where,
    orderBy,
    serverTimestamp,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // Firebase Config (VaultFlow-Dev / vaultflow-dev-marc35)
  const firebaseConfig = {
    apiKey: "AIzaSyDIXLjoqxDQrDr7rhxfBjCBzsXZUycTWD0",
    authDomain: "vaultflow-dev-marc35.firebaseapp.com",
    projectId: "vaultflow-dev-marc35",
    storageBucket: "vaultflow-dev-marc35.firebasestorage.app",
    messagingSenderId: "806046110940",
    appId: "1:806046110940:web:aab0a3245bb304e14b9019",
    measurementId: "G-CMZTW66KS9"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Allowlist (somente voc√™s 3)
  const ALLOWED_EMAILS = new Set([
    "hbmarc35@gmail.com",
    "lzmarc25@gmail.com",
    "herbertmarck@gmail.com"
  ]);

  const COUPLE_WALLET_ID = "w_casal";
  const PERSONAL_WALLETS = new Set(["w_marcelino", "w_luiza"]);
  const KNOWN_WALLETS = ["w_marcelino", "w_luiza", "w_casal"];
  const FRIENDLY_WALLET_NAMES = {
    w_marcelino: "Marcelino",
    w_luiza: "Luiza",
    w_casal: "Casal"
  };
  const USER_PERSONAL_WALLET = {
    "hbmarc35@gmail.com": "w_marcelino",
    "lzmarc25@gmail.com": "w_luiza",
    "herbertmarck@gmail.com": "w_marcelino"
  };

  const $ = (id) => document.getElementById(id);

  const btnEmail = $("btnEmail");
  const btnGoogle = $("btnGoogle");
  const btnLogout = $("btnLogout");
  const authCard = $("authCard");

  const authStatus = $("authStatus");
  const authError = $("authError");

  const appGrid = $("appGrid");
  const pageTitle = $("pageTitle");
  const navButtons = Array.from(document.querySelectorAll("[data-page-target]"));
  const pages = {
    dashboard: $("page-dashboard"),
    transactions: $("page-transactions"),
    categories: $("page-categories"),
    settings: $("page-settings")
  };

  const me = $("me");

  const walletSelect = $("walletSelect");
  const walletInfo = $("walletInfo");

  const monthInput = $("month");
  const btnReload = $("btnReload");

  const kpiIncome = $("kpiIncome");
  const kpiExpense = $("kpiExpense");
  const kpiBalance = $("kpiBalance");
  const coupleBreakdown = $("coupleBreakdown");

  const coupleTabs = $("coupleTabs");
  const coupleHint = $("coupleHint");

  const incomeList = $("incomeList");
  const expenseList = $("expenseList");
  const dashboardStatus = $("dashboardStatus");

  const catName = $("catName");
  const catKind = $("catKind");
  const btnAddCat = $("btnAddCat");
  const btnSeedCats = $("btnSeedCats");
  const catStatus = $("catStatus");
  const catTable = $("catTable");

  const txnDate = $("txnDate");
  const txnType = $("txnType");
  const txnCat = $("txnCat");
  const txnAmount = $("txnAmount");
  const txnNote = $("txnNote");
  const btnAddTxn = $("btnAddTxn");

  const txnTable = $("txnTable");
  const txnStatus = $("txnStatus");

  const appError = $("appError");
  const opsError = $("opsError");
  const appShell = document.querySelector(".app-shell");
  const sidebarToggle = $("sidebarToggle");

  const state = {
    user: null,
    email: null,
    uid: null,
    displayName: "",
    walletId: null,
    walletRole: null,
    walletType: null,
    walletName: null,
    walletLabels: new Map(),
    coupleTab: "totals",
    categories: new Map(), // catId -> {name, kind}
    currentRows: []
  };
  Object.entries(FRIENDLY_WALLET_NAMES).forEach(([id, label]) => state.walletLabels.set(id, label));

  function setAuthMessage(msg, isError = false) {
    authStatus.textContent = isError ? "" : msg;
    authError.textContent = isError ? msg : "";
  }
  function setAppError(msg = "") { appError.textContent = msg; }
  function setOpsError(msg = "") { opsError.textContent = msg; }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function toBRL(cents) {
    const v = (Number(cents || 0) / 100);
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function parseAmountToCents(text) {
    const clean = (text ?? "").trim().replace(/\./g, "").replace(",", ".");
    const n = Number(clean);
    if (!Number.isFinite(n)) return null;
    return Math.round(n * 100);
  }

  function yyyyMMFromMonthInput(value) {
    if (!value || !/^\d{4}-\d{2}$/.test(value)) return null;
    return value;
  }

  function yyyyMMFromDateStr(dateStr) {
    if (!dateStr || dateStr.length < 7) return null;
    return dateStr.slice(0, 7);
  }

  function yyyyMMFromTimestamp(ts) {
    try {
      const d = ts?.toDate?.();
      if (!d) return null;
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      return `${d.getFullYear()}-${mm}`;
    } catch { return null; }
  }

  function startEndForMonth(yyyyMM) {
    const [y, m] = yyyyMM.split("-").map(Number);
    const start = new Date(Date.UTC(y, m - 1, 1, 0, 0, 0));
    const end = new Date(Date.UTC(y, m, 1, 0, 0, 0));
    return { start, end };
  }

  function toISODateLocal(d) {
    const pad = (x) => String(x).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function renderKPIs(incomeCents, expenseCents) {
    const bal = Number(incomeCents || 0) - Number(expenseCents || 0);
    kpiIncome.textContent = toBRL(incomeCents);
    kpiExpense.textContent = toBRL(expenseCents);
    kpiBalance.textContent = toBRL(bal);
  }

  function renderMovementList(target, rows) {
    if (!target) return;
    target.innerHTML = "";
    if (!rows || rows.length === 0) {
      target.innerHTML = `<p class="muted">Sem lan√ßamentos.</p>`;
      return;
    }
    const limited = rows.slice(0, 6);
    for (const r of limited) {
      const dt = r.date ? toISODateLocal(r.date) : "-";
      const card = document.createElement("div");
      card.className = "move-card";
      card.innerHTML = `
        <div class="move-meta">
          <span>${escapeHtml(dt)} - ${escapeHtml(r.categoryName || "-")}</span>
          <span class="move-amount">${toBRL(Math.abs(r.amountCents))}</span>
        </div>
        <div class="muted">${escapeHtml(r.note || "")}${r.sourceLabel ? ` - ${escapeHtml(r.sourceLabel)}` : ""}</div>
      `;
      target.appendChild(card);
    }
  }

  function renderDashboardMovements(rows) {
    const incomeRows = [];
    const expenseRows = [];
    for (const r of rows || []) {
      if (r.type === "income") incomeRows.push(r);
      else expenseRows.push(r);
    }
    renderMovementList(incomeList, incomeRows);
    renderMovementList(expenseList, expenseRows);
  }

  function syncCoupleTabs() {
    if (!coupleTabs) return;
    coupleTabs.querySelectorAll(".tab").forEach((btn) => {
      const tab = btn.getAttribute("data-tab");
      btn.classList.toggle("active", tab === state.coupleTab);
    });
  }

  function isCoupleWallet() {
    return state.walletId === COUPLE_WALLET_ID && state.walletType === "aggregate";
  }

  function isPersonalWalletId(walletId) {
    return PERSONAL_WALLETS.has(walletId);
  }

  function friendlyWalletLabel(walletId, fallbackName = "") {
    if (FRIENDLY_WALLET_NAMES[walletId]) return FRIENDLY_WALLET_NAMES[walletId];
    if (fallbackName) {
      const trimmed = fallbackName.includes("(") ? fallbackName.split("(")[0].trim() : fallbackName.trim();
      if (trimmed) return trimmed;
    }
    if (walletId?.startsWith("w_")) {
      const slug = walletId.slice(2).replace(/_/g, " ");
      return slug ? slug.charAt(0).toUpperCase() + slug.slice(1) : walletId;
    }
    return walletId || fallbackName || "";
  }

  function showPage(key) {
    const titles = {
      dashboard: "Dashboard",
      transactions: "Transa√ß√µes",
      categories: "Categorias",
      settings: "Configura√ß√µes"
    };

    Object.entries(pages).forEach(([pageKey, el]) => {
      if (!el) return;
      const active = pageKey === key;
      el.classList.toggle("active", active);
      el.style.display = active ? "grid" : "none";
    });

    navButtons.forEach((btn) => {
      const target = btn.getAttribute("data-page-target");
      btn.classList.toggle("active", target === key);
    });

    if (pageTitle) pageTitle.textContent = titles[key] ?? "VaultFlow";
  }

  // ===== Bootstrap =====

  async function ensureUserProfile(user) {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        displayName: user.displayName ?? (user.email?.split("@")[0] ?? "Usu√°rio"),
        email: (user.email ?? "").toLowerCase(),
        createdAt: Timestamp.now()
      }, { merge: true });
    } else {
      await setDoc(ref, {
        email: (user.email ?? "").toLowerCase(),
        displayName: snap.data().displayName ?? user.displayName ?? "Usu√°rio"
      }, { merge: true });
    }
  }

  async function ensureWalletMetaIfOwner(user) {
    const email = (user.email ?? "").toLowerCase();
    const uid = user.uid;

    const isMarcelino = email === "hbmarc35@gmail.com";
    const isLuiza = email === "lzmarc25@gmail.com";

    async function upsertWallet(walletId, dataIfCreate, dataMerge) {
      const wRef = doc(db, "wallets", walletId);
      const wSnap = await getDoc(wRef);
      if (!wSnap.exists()) {
        await setDoc(wRef, dataIfCreate, { merge: false });
      } else {
        await setDoc(wRef, dataMerge, { merge: true });
      }
    }

    if (isMarcelino) {
      await upsertWallet(
        "w_marcelino",
        { name: "Marcelino (Pessoal)", type: "personal", createdBy: uid, createdAt: Timestamp.now() },
        { name: "Marcelino (Pessoal)", type: "personal" }
      );
    }

    if (isLuiza) {
      await upsertWallet(
        "w_luiza",
        { name: "Luiza (Pessoal)", type: "personal", createdBy: uid, createdAt: Timestamp.now() },
        { name: "Luiza (Pessoal)", type: "personal" }
      );
    }

    if (isMarcelino || isLuiza) {
      const srcRefs = [
        doc(db, "wallets", "w_marcelino"),
        doc(db, "wallets", "w_luiza")
      ];
      await upsertWallet(
        "w_casal",
        {
          name: "Casal (Agregado)",
          type: "aggregate",
          createdBy: uid,
          createdAt: Timestamp.now(),
          sources: srcRefs
        },
        {
          name: "Casal (Agregado)",
          type: "aggregate",
          sources: srcRefs
        }
      );
    }
  }

  async function ensureMembershipShortcutsFromMembers(user) {
    const membershipCol = collection(db, "users", user.uid, "memberships");
    const existing = await getDocs(membershipCol);
    if (existing.size > 0) return;

    for (const walletId of KNOWN_WALLETS) {
      try {
        const mRef = doc(db, "wallets", walletId, "members", user.uid);
        const mSnap = await getDoc(mRef);
        if (!mSnap.exists()) continue;

        const role = mSnap.data().role;
        await setDoc(doc(db, "users", user.uid, "memberships", walletId), {
          role,
          createdAt: Timestamp.now()
        }, { merge: true });
      } catch {
        // ignore
      }
    }
  }

  async function loadWalletOptions(user) {
    const membershipCol = collection(db, "users", user.uid, "memberships");
    const snaps = await getDocs(membershipCol);
    const list = snaps.docs.map(d => ({ walletId: d.id, role: d.data().role }));

    walletSelect.innerHTML = "";
    state.walletLabels.clear();
    for (const item of list) {
      let label = item.walletId;
      let type = "?";
      try {
        const wSnap = await getDoc(doc(db, "wallets", item.walletId));
        if (wSnap.exists()) {
          label = wSnap.data().name ?? item.walletId;
          type = wSnap.data().type ?? "?";
        }
      } catch {}

      const friendly = friendlyWalletLabel(item.walletId, label);
      state.walletLabels.set(item.walletId, friendly);

      const opt = document.createElement("option");
      opt.value = item.walletId;
      opt.textContent = friendly;
      opt.dataset.type = type;
      walletSelect.appendChild(opt);
    }
    return list;
  }

  function selectDefaultWallet(wallets) {
    const current = walletSelect.value;
    if (current && wallets.some(w => w.walletId === current)) return;
    const preferredId = USER_PERSONAL_WALLET[state.email];
    if (preferredId && wallets.some(w => w.walletId === preferredId)) {
      walletSelect.value = preferredId;
    } else if (wallets.length > 0) {
      walletSelect.value = wallets[0].walletId;
    }
  }

  async function refreshWalletContext() {
    setAppError("");
    setOpsError("");

    const walletId = walletSelect.value;
    if (!walletId) {
      setAppError("Nenhuma carteira dispon√≠vel para sua conta.");
      return;
    }

    let role = null;
    try {
      const mSnap = await getDoc(doc(db, "users", state.uid, "memberships", walletId));
      role = mSnap.exists() ? mSnap.data().role : null;
    } catch {}

    let name = walletId;
    let type = "?";
    try {
      const wSnap = await getDoc(doc(db, "wallets", walletId));
      if (wSnap.exists()) {
        name = wSnap.data().name ?? walletId;
        type = wSnap.data().type ?? "?";
      }
    } catch (e) {
      setAppError("N√£o foi poss√≠vel carregar a carteira. Tente novamente.");
    }

    state.walletId = walletId;
    state.walletRole = role ?? "-";
    state.walletType = type;
    state.walletName = friendlyWalletLabel(walletId, name);
    state.walletLabels.set(walletId, state.walletName);

    walletInfo.textContent = `Carteira atual: ${state.walletName}`;

    const couple = isCoupleWallet();
    state.coupleTab = couple ? "details" : "totals";
    syncCoupleTabs();
    coupleTabs.style.display = couple ? "" : "none";
    coupleHint.style.display = couple ? "" : "none";
    coupleBreakdown.style.display = couple ? "" : "none";

    const disablePersonal = couple;
    [catName, catKind, btnAddCat, btnSeedCats].forEach((el) => el && (el.disabled = disablePersonal));
    [txnDate, txnType, txnCat, txnAmount, txnNote, btnAddTxn].forEach((el) => el && (el.disabled = disablePersonal));
    if (catStatus) catStatus.textContent = disablePersonal ? "Categorias n√£o dispon√≠veis nesta vis√£o." : "";
    if (disablePersonal && txnStatus) txnStatus.textContent = "Vis√£o consolidada em modo leitura.";

    const now = new Date();
    txnDate.value = toISODateLocal(now);

    await reloadAll();
  }

  // ===== Categories =====

  async function loadCategories() {
    state.categories.clear();
    txnCat.innerHTML = "";

    if (isCoupleWallet()) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "‚Äî";
      txnCat.appendChild(opt);
      catTable.innerHTML = "";
      catStatus.textContent = "Categorias n√£o dispon√≠veis nesta carteira.";
      return;
    }

    const colRef = collection(db, "wallets", state.walletId, "categories");
    const snaps = await getDocs(colRef);

    for (const d of snaps.docs) {
      const data = d.data();
      state.categories.set(d.id, { name: data.name, kind: data.kind });
    }

    if (state.categories.size === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sem categorias (crie uma)";
      txnCat.appendChild(opt);
    } else {
      for (const [id, c] of state.categories.entries()) {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = c.name;
        txnCat.appendChild(opt);
      }
    }

    renderCategoriesTable();
    catStatus.textContent = `Categorias carregadas: ${state.categories.size}`;
  }

  function renderCategoriesTable() {
    catTable.innerHTML = "";
    const entries = Array.from(state.categories.entries())
      .map(([id, c]) => ({ id, ...c }))
      .sort((a, b) => (a.name ?? "").localeCompare(b.name ?? ""));

    for (const c of entries) {
      const kindLabel = c.kind === "income" ? "Receita" : (c.kind === "expense" ? "Despesa" : "Ambos");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td><span class="badge">${escapeHtml(kindLabel)}</span></td>
        <td class="right actions">
          <button class="icon-action" data-edit-cat="${c.id}" aria-label="Editar">‚úè</button>
          <button class="icon-action" data-del-cat="${c.id}" aria-label="Excluir">üóë</button>
        </td>
      `;
      catTable.appendChild(tr);
    }

    catTable.querySelectorAll("button[data-edit-cat]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-edit-cat");
        await editCategory(id);
      });
    });

    catTable.querySelectorAll("button[data-del-cat]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-cat");
        if (!confirm("Excluir esta categoria?")) return;
        try {
          await deleteDoc(doc(db, "wallets", state.walletId, "categories", id));
          await loadCategories();
        } catch (e) {
          catStatus.textContent = "N√£o foi poss√≠vel excluir a categoria.";
        }
      });
    });
  }

  async function addCategory() {
    setOpsError("");
    catStatus.textContent = "";
    const name = (catName.value ?? "").trim();
    const kind = catKind.value;

    if (!name) {
      catStatus.textContent = "Informe o nome da categoria.";
      return;
    }

    try {
      await addDoc(collection(db, "wallets", state.walletId, "categories"), {
        name,
        kind,
        createdAt: serverTimestamp(),
        createdBy: state.uid
      });
      catName.value = "";
      await loadCategories();
    } catch (e) {
      catStatus.textContent = "N√£o foi poss√≠vel adicionar a categoria.";
    }
  }

  async function editCategory(catId) {
    setOpsError("");
    const current = state.categories.get(catId);
    const nextName = prompt("Editar nome da categoria", current?.name ?? "");
    if (nextName == null) return;
    const trimmed = nextName.trim();
    if (!trimmed) return;

    try {
      await setDoc(doc(db, "wallets", state.walletId, "categories", catId), { name: trimmed }, { merge: true });
      await loadCategories();
    } catch (e) {
      catStatus.textContent = "N√£o foi poss√≠vel atualizar a categoria.";
    }
  }

  async function seedDefaultCategories() {
    setOpsError("");
    if (!confirm("Criar categorias padr√£o nesta carteira?")) return;

    const defaults = [
      { name: "Alimenta√ß√£o", kind: "expense" },
      { name: "Transporte", kind: "expense" },
      { name: "Moradia", kind: "expense" },
      { name: "Sa√∫de", kind: "expense" },
      { name: "Lazer", kind: "expense" },
      { name: "Compras", kind: "expense" },
      { name: "Sal√°rio", kind: "income" },
      { name: "Outras receitas", kind: "income" }
    ];

    try {
      for (const c of defaults) {
        await addDoc(collection(db, "wallets", state.walletId, "categories"), {
          ...c,
          createdAt: serverTimestamp(),
          createdBy: state.uid
        });
      }
      await loadCategories();
      catStatus.textContent = "Categorias padr√£o criadas.";
    } catch (e) {
      catStatus.textContent = "N√£o foi poss√≠vel criar categorias padr√£o agora.";
    }
  }

  // ===== Auto-sync Casal (corrigido: reads antes de writes) =====

  function clampNonNegative(n) {
    n = Number(n || 0);
    return n < 0 ? 0 : n;
  }

  function computeCoupleSourceNext(repData, sourceWalletId, deltaIncomeCents, deltaExpenseCents) {
    const sources = repData?.sources ?? {};
    const cur = sources?.[sourceWalletId] ?? {};
    const curIncome = Number(cur.incomeCents || 0);
    const curExpense = Number(cur.expenseCents || 0);

    const nextIncome = clampNonNegative(curIncome + Number(deltaIncomeCents || 0));
    const nextExpense = clampNonNegative(curExpense + Number(deltaExpenseCents || 0));

    return { nextIncome, nextExpense };
  }

  async function addTransaction() {
    setOpsError("");

    if (isCoupleWallet()) {
      setOpsError("Lan√ßamentos s√≥ podem ser feitos em carteiras pessoais (vis√£o consolidada √© leitura).");
      return;
    }

    const dateStr = txnDate.value;
    if (!dateStr) { setOpsError("Informe a data."); return; }

    const type = txnType.value;
    const catId = txnCat.value;
    if (!catId) { setOpsError("Selecione uma categoria."); return; }

    const amountCents = parseAmountToCents(txnAmount.value);
    if (amountCents == null || amountCents <= 0) {
      setOpsError("Informe um valor v√°lido (maior que zero).");
      return;
    }

    const note = (txnNote.value ?? "").trim();
    const cat = state.categories.get(catId);
    const categoryName = cat?.name ?? "";

    const personalWalletId = state.walletId;
    const shouldSyncToCouple = isPersonalWalletId(personalWalletId);

    btnAddTxn.disabled = true;
    btnAddTxn.textContent = "Salvando...";

    try {
      const dt = new Date(dateStr + "T00:00:00");
      const ts = Timestamp.fromDate(dt);
      const yyyyMM = yyyyMMFromDateStr(dateStr);

      const personalCol = collection(db, "wallets", personalWalletId, "transactions");
      const newRef = doc(personalCol); // gera ID j√°

      const txnPayload = {
        date: ts,
        amountCents,
        type,
        categoryId: catId,
        categoryName,
        note,
        createdAt: serverTimestamp(),
        createdBy: state.uid
      };

      const viewId = `${personalWalletId}_${newRef.id}`;
      const viewRef = doc(db, "wallets", COUPLE_WALLET_ID, "transactions_view", viewId);

      const reportRef = doc(db, "wallets", COUPLE_WALLET_ID, "reports", yyyyMM);

      await runTransaction(db, async (tx) => {
        // ===== READS FIRST =====
        let repSnap = null;
        let repData = null;
        let repExists = false;

        if (shouldSyncToCouple) {
          repSnap = await tx.get(reportRef);
          repExists = repSnap.exists();
          repData = repExists ? repSnap.data() : null;
        }

        // ===== WRITES AFTER READS =====
        tx.set(newRef, txnPayload);

        if (shouldSyncToCouple) {
          tx.set(viewRef, {
            sourceWalletId: personalWalletId,
            sourceTxnId: newRef.id,
            sourceUid: state.uid,
            date: ts,
            amountCents,
            type,
            categoryId: catId,
            categoryName,
            note,
            syncedAt: serverTimestamp()
          }, { merge: true });

          const deltaIncome = (type === "income") ? amountCents : 0;
          const deltaExpense = (type === "expense") ? amountCents : 0;

          const { nextIncome, nextExpense } = computeCoupleSourceNext(repData, personalWalletId, deltaIncome, deltaExpense);

          const reportPatch = {
            month: yyyyMM,
            updatedAt: serverTimestamp(),
            updatedBy: state.uid,
            sources: {
              [personalWalletId]: {
                incomeCents: nextIncome,
                expenseCents: nextExpense,
                updatedAt: serverTimestamp(),
                updatedBy: state.uid
              }
            }
          };

          const mergeFields = ["month", "updatedAt", "updatedBy", `sources.${personalWalletId}`];

          // s√≥ cria createdAt/createdBy se ainda n√£o existe
          if (!repExists) {
            reportPatch.createdAt = serverTimestamp();
            reportPatch.createdBy = state.uid;
            mergeFields.push("createdAt", "createdBy");
          }

          tx.set(reportRef, reportPatch, { mergeFields });
        }
      });

      txnAmount.value = "";
      txnNote.value = "";

      await reloadAll();
    } catch (e) {
      setOpsError("N√£o foi poss√≠vel salvar a transa√ß√£o. Tente novamente.");
    } finally {
      btnAddTxn.disabled = false;
      btnAddTxn.textContent = "Adicionar";
    }
  }

  async function deleteTransactionPersonalAndSync(txnId) {
    setOpsError("");

    const personalWalletId = state.walletId;
    if (!isPersonalWalletId(personalWalletId)) {
      setOpsError("Exclus√£o autom√°tica s√≥ funciona em carteiras pessoais.");
      return;
    }

    const personalTxnRef = doc(db, "wallets", personalWalletId, "transactions", txnId);
    const viewRef = doc(db, "wallets", COUPLE_WALLET_ID, "transactions_view", `${personalWalletId}_${txnId}`);

    try {
      await runTransaction(db, async (tx) => {
        // ===== READS FIRST =====
        const txnSnap = await tx.get(personalTxnRef);
        if (!txnSnap.exists()) return;

        const t = txnSnap.data();
        const amount = Number(t.amountCents || 0);
        const type = t.type ?? "expense";
        const yyyyMM = yyyyMMFromTimestamp(t.date);

        const reportRef = doc(db, "wallets", COUPLE_WALLET_ID, "reports", yyyyMM);
        const repSnap = await tx.get(reportRef);
        const repExists = repSnap.exists();
        const repData = repExists ? repSnap.data() : null;

        // ===== WRITES AFTER READS =====
        tx.delete(personalTxnRef);
        tx.delete(viewRef);

        // atualiza totals do casal (decremento)
        const deltaIncome = (type === "income") ? -amount : 0;
        const deltaExpense = (type === "expense") ? -amount : 0;

        const { nextIncome, nextExpense } = computeCoupleSourceNext(repData, personalWalletId, deltaIncome, deltaExpense);

        const reportPatch = {
          month: yyyyMM,
          updatedAt: serverTimestamp(),
          updatedBy: state.uid,
          sources: {
            [personalWalletId]: {
              incomeCents: nextIncome,
              expenseCents: nextExpense,
              updatedAt: serverTimestamp(),
              updatedBy: state.uid
            }
          }
        };

        const mergeFields = ["month", "updatedAt", "updatedBy", `sources.${personalWalletId}`];

        // se report n√£o existia (situa√ß√£o rara), cria sem quebrar
        if (!repExists) {
          reportPatch.createdAt = serverTimestamp();
          reportPatch.createdBy = state.uid;
          mergeFields.push("createdAt", "createdBy");
        }

        tx.set(reportRef, reportPatch, { mergeFields });
      });

      await reloadAll();
    } catch (e) {
      setOpsError("N√£o foi poss√≠vel excluir a transa√ß√£o. Tente novamente.");
    }
  }

  // ===== Transactions list / Couple views =====

  function renderTxnRows(rows, { allowDelete, isCoupleView }) {
    txnTable.innerHTML = "";

    for (const r of rows) {
      const dt = r.date ? toISODateLocal(r.date) : "-";
      const display = toBRL(Math.abs(r.amountCents));
      const prefix = (r.type === "income") ? "+" : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nowrap">${escapeHtml(dt)}</td>
          <td>${escapeHtml(r.categoryName || "-")}</td>
          <td>${escapeHtml(r.note || "")}${isCoupleView ? `<div class="muted" style="margin-top:4px;">${escapeHtml(r.sourceLabel || "")}</div>` : ""}</td>
          <td class="right nowrap">${prefix} ${escapeHtml(display)}</td>
          <td class="right nowrap">
            ${allowDelete ? `<button class="ghost" data-del-txn="${r.id}">Excluir</button>` : `<span class="muted">‚Äì</span>`}
          </td>
        `;
      txnTable.appendChild(tr);
    }

    if (allowDelete) {
      txnTable.querySelectorAll("button[data-del-txn]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-del-txn");
          if (!confirm("Excluir esta transa√ß√£o? Isso tamb√©m remover√° do consolidado.")) return;
          await deleteTransactionPersonalAndSync(id);
        });
      });
    }
  }

  async function loadCoupleTotals(yyyyMM) {
    coupleBreakdown.style.display = "";
    coupleBreakdown.innerHTML = "";
    state.currentRows = [];

    let income = 0;
    let expense = 0;

    try {
      const repRef = doc(db, "wallets", COUPLE_WALLET_ID, "reports", yyyyMM);
      const repSnap = await getDoc(repRef);

      if (!repSnap.exists()) {
        coupleBreakdown.innerHTML = `<p class="muted">Sem totais para ${escapeHtml(yyyyMM)}. Adicione lan√ßamentos nas carteiras pessoais para gerar automaticamente.</p>`;
        return { income: 0, expense: 0, balance: 0 };
      }

      const rep = repSnap.data();
      const sources = rep.sources ?? {};

      const lines = [];
      for (const [sourceWalletId, s] of Object.entries(sources)) {
        const inc = Number(s?.incomeCents || 0);
        const exp = Number(s?.expenseCents || 0);
        income += inc;
        expense += exp;
        const label = state.walletLabels.get(sourceWalletId) ?? friendlyWalletLabel(sourceWalletId);

        lines.push(`
          <div class="kpi" style="margin-top:8px;">
            <div class="label">${escapeHtml(label)}</div>
            <div class="value">${toBRL(inc - exp)}</div>
            <div class="muted">Receitas: ${toBRL(inc)} | Despesas: ${toBRL(exp)}</div>
          </div>
        `);
      }

      coupleBreakdown.innerHTML = lines.length
        ? `<div class="muted">Quebra por fonte (somado no total acima):</div>${lines.join("")}`
        : `<p class="muted">Dados consolidados dispon√≠veis, mas sem fontes preenchidas.</p>`;

      return { income, expense, balance: income - expense };
    } catch (e) {
      setOpsError("N√£o foi poss√≠vel carregar o consolidado agora. Tente novamente.");
      coupleBreakdown.innerHTML = `<p class="err">Falha ao carregar o consolidado.</p>`;
      return { income: 0, expense: 0, balance: 0 };
    }
  }

  async function loadCoupleDetails(startTS, endTS) {
    try {
      const qRef = query(
        collection(db, "wallets", COUPLE_WALLET_ID, "transactions_view"),
        where("date", ">=", startTS),
        where("date", "<", endTS),
        orderBy("date", "desc")
      );

      const snaps = await getDocs(qRef);
      const rows = [];
      let income = 0, expense = 0;

      for (const d of snaps.docs) {
        const t = d.data();
        const amount = Number(t.amountCents || 0);
        if (t.type === "income") income += amount;
        else expense += amount;
        const sourceLabel = t.sourceWalletId ? `Fonte: ${friendlyWalletLabel(t.sourceWalletId, state.walletLabels.get(t.sourceWalletId))}` : "";

        rows.push({
          id: d.id,
          date: t.date?.toDate?.() ?? null,
          categoryName: t.categoryName ?? "",
          note: t.note ?? "",
          type: t.type ?? "",
          amountCents: amount,
          sourceLabel
        });
      }

      state.currentRows = rows;
      renderTxnRows(rows, { allowDelete: false, isCoupleView: true });
      coupleBreakdown.style.display = "none";

      return { income, expense, balance: income - expense };
    } catch (e) {
      setOpsError("N√£o foi poss√≠vel carregar os detalhes do consolidado.");
      txnTable.innerHTML = "";
      return { income: 0, expense: 0, balance: 0 };
    }
  }

  async function loadTransactionsForMonth() {
    txnTable.innerHTML = "";
    txnStatus.textContent = "";
    setOpsError("");
    state.currentRows = [];
    renderDashboardMovements([]);
    dashboardStatus.textContent = "";

    const yyyyMM = yyyyMMFromMonthInput(monthInput.value);
    if (!yyyyMM) { setOpsError("Selecione um m√™s v√°lido."); return { income: 0, expense: 0, balance: 0 }; }

    const { start, end } = startEndForMonth(yyyyMM);
    const startTS = Timestamp.fromDate(start);
    const endTS = Timestamp.fromDate(end);

    if (isCoupleWallet()) {
      if (state.coupleTab === "totals") {
        const totals = await loadCoupleTotals(yyyyMM);
        renderKPIs(totals.income, totals.expense);
        txnStatus.textContent = "Totais consolidados carregados.";
        renderDashboardMovements([]);
        dashboardStatus.textContent = "Use a aba Detalhes para ver lan√ßamentos.";
        return totals;
      } else {
        const totals = await loadCoupleDetails(startTS, endTS);
        renderKPIs(totals.income, totals.expense);
        txnStatus.textContent = "Detalhes consolidados carregados.";
        renderDashboardMovements(state.currentRows);
        dashboardStatus.textContent = state.currentRows.length ? "Movimenta√ß√µes consolidadas do m√™s." : "Sem lan√ßamentos neste m√™s.";
        return totals;
      }
    }

    let income = 0;
    let expense = 0;

    try {
      const qRef = query(
        collection(db, "wallets", state.walletId, "transactions"),
        where("date", ">=", startTS),
        where("date", "<", endTS),
        orderBy("date", "desc")
      );

      const snaps = await getDocs(qRef);
      const rows = [];

      for (const d of snaps.docs) {
        const t = d.data();
        const amount = Number(t.amountCents || 0);
        if (t.type === "income") income += amount;
        else expense += amount;

        rows.push({
          id: d.id,
          date: t.date?.toDate?.() ?? null,
          categoryName: t.categoryName ?? "",
          note: t.note ?? "",
          type: t.type ?? "",
          amountCents: amount
        });
      }

      state.currentRows = rows;
      renderDashboardMovements(rows);
      renderTxnRows(rows, { allowDelete: true, isCoupleView: false });
      txnStatus.textContent = `Transa√ß√µes no m√™s: ${rows.length}`;
      renderKPIs(income, expense);
      dashboardStatus.textContent = rows.length ? "Movimenta√ß√µes do m√™s selecionado." : "Sem lan√ßamentos no m√™s.";

      return { income, expense, balance: income - expense };
    } catch (e) {
      setOpsError("N√£o foi poss√≠vel carregar suas movimenta√ß√µes. Tente novamente.");
      renderKPIs(0, 0);
      return { income: 0, expense: 0, balance: 0 };
    }
  }

  async function reloadAll() {
    setOpsError("");
    if (!isCoupleWallet()) await loadCategories();
    else {
      state.categories.clear();
      txnCat.innerHTML = `<option value="">‚Äî</option>`;
      catTable.innerHTML = "";
      catStatus.textContent = "Categorias n√£o dispon√≠veis nesta carteira.";
    }
    await loadTransactionsForMonth();
  }

  // ===== Events =====

  btnEmail.addEventListener("click", async () => {
    try {
      setAuthMessage("Entrando...");
      const email = $("email").value.trim().toLowerCase();
      const pass = $("pass").value;

      if (!ALLOWED_EMAILS.has(email)) throw new Error("Este e-mail n√£o est√° autorizado.");

      await signInWithEmailAndPassword(auth, email, pass);
      setAuthMessage("Login OK.");
    } catch (e) {
      const msg = e?.message ?? String(e);
      const friendly = msg.toLowerCase().includes("autoriz")
        ? msg
        : "N√£o foi poss√≠vel entrar. Confira seus dados e tente novamente.";
      setAuthMessage(friendly, true);
    }
  });

  btnGoogle.addEventListener("click", async () => {
    try {
      setAuthMessage("Abrindo Google...");
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const email = (result.user.email ?? "").toLowerCase();

      if (!ALLOWED_EMAILS.has(email)) {
        await signOut(auth);
        throw new Error("Conta Google n√£o autorizada.");
      }

      setAuthMessage("Login Google OK.");
    } catch (e) {
      const msg = e?.message ?? String(e);
      const friendly = msg.toLowerCase().includes("autoriz")
        ? msg
        : "N√£o foi poss√≠vel entrar com Google agora. Tente novamente.";
      setAuthMessage(friendly, true);
    }
  });

  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
  });

  btnReload.addEventListener("click", reloadAll);
  walletSelect.addEventListener("change", refreshWalletContext);
  monthInput.addEventListener("change", reloadAll);

  btnAddCat.addEventListener("click", addCategory);
  btnSeedCats.addEventListener("click", seedDefaultCategories);
  btnAddTxn.addEventListener("click", addTransaction);
  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-page-target");
      if (!target) return;
      showPage(target);
    });
  });
  if (sidebarToggle && appShell) {
    sidebarToggle.addEventListener("click", () => {
      const collapsed = appShell.classList.toggle("collapsed");
      sidebarToggle.setAttribute("aria-pressed", collapsed ? "true" : "false");
    });
  }

  coupleTabs.addEventListener("click", async (e) => {
    const btn = e.target?.closest?.("button[data-tab]");
    if (!btn) return;

    coupleTabs.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    btn.classList.add("active");

    state.coupleTab = btn.getAttribute("data-tab") || "totals";
    syncCoupleTabs();
    await reloadAll();
  });

  (function initDates() {
    const now = new Date();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    monthInput.value = `${now.getFullYear()}-${mm}`;
    txnDate.value = toISODateLocal(now);
  })();

  onAuthStateChanged(auth, async (user) => {
    try {
      setAuthMessage("");
      setAppError("");
      setOpsError("");

      if (!user) {
        btnLogout.style.display = "none";
        appGrid.style.display = "none";
        me.textContent = "Aguardando login";
        renderDashboardMovements([]);
        walletInfo.textContent = "";
        if (authCard) authCard.style.display = "";
        return;
      }

      const email = (user.email ?? "").toLowerCase();
      if (!ALLOWED_EMAILS.has(email)) {
        await signOut(auth);
        throw new Error("Usu√°rio autenticado, mas n√£o autorizado.");
      }

      state.user = user;
      state.email = email;
      state.uid = user.uid;
      state.displayName = user.displayName ?? (user.email?.split("@")[0] ?? "Usu√°rio");

      btnLogout.style.display = "";
      appGrid.style.display = "";
      if (authCard) authCard.style.display = "none";

      me.textContent = state.displayName;

      await ensureUserProfile(user);
      await ensureWalletMetaIfOwner(user);
      await ensureMembershipShortcutsFromMembers(user);

      const wallets = await loadWalletOptions(user);
      selectDefaultWallet(wallets);

      await refreshWalletContext();
      showPage("dashboard");

      setAuthMessage("Sess√£o ativa.");
    } catch (e) {
      const raw = e?.message ?? "";
      const friendly = raw.includes("Firebase") ? "N√£o foi poss√≠vel iniciar a sess√£o. Tente novamente." : (raw || "N√£o foi poss√≠vel iniciar a sess√£o. Tente novamente.");
      setAppError(friendly);
    }
  });


</script>

</body>
</html>
